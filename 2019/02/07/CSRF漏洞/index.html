<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="向来拿不起,也放不下。QQ:1807801293">
    

    <!--Author-->
    
        <meta name="author" content="Yogurt">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="CSRF漏洞"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="向来拿不起,也放不下。QQ:1807801293" />
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="Yogurt"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>CSRF漏洞 - Yogurt</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Google Analytics -->
    


</head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/">
                    Home
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    Archives
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/about.html">
                    About
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/tags">
                    Tags
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/categories">
                    Categories
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=990 height=86 src="//music.163.com/outchain/player?type=2&id=1299711624&auto=1&height=66"></iframe>
<header>
    <div class="logo">
        <a href="/"><i class="logo-icon fa fa-cube" aria-hidden="true"></i></a>
        
    </div>
</header>

        <section class="main">
            
<div class="post">

    <div class="post-header">
        <h1 class="title">
            <a href="/2019/02/07/CSRF漏洞/">
                CSRF漏洞
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2019-02-07</span>
            
            
                <a href="#disqus_thread" class="comments">Comments</a>
            
            
                <span class="category">
                    <a href="/categories/web/">web</a>
                </span>
            
        </div>
    </div>

    <div class="content">

        <!-- Gallery -->
        

        <!-- Post Content -->
        <h1 id="何为CSRF"><a href="#何为CSRF" class="headerlink" title="何为CSRF"></a>何为CSRF</h1><p><strong>CSRF</strong>（Cross-site request forgery）跨站请求伪造,通常缩写为CSRF或者XSRF，是一种对网站的恶意利用。与XSS非常不同，XSS利用站点内的信任用户，而CSRF则通过伪装成受信任用户的请求来利用受信任的网站。与XSS攻击相比，CSRF攻击往往不大流行（因此对其进行防范的资源也相当稀少）和难以防范，所以被认为比XSS更具危险性。——来自百度<br>跨站请求伪造就是在另一个网站向另一个网站(本该真正用户请求的网站)发送一个伪造的请求，而接受请求的网站以为该伪造的请求是用户发送来的，故将此请求执行，造成了CSRF攻击。  </p>
<h1 id="CSRF可以做什么"><a href="#CSRF可以做什么" class="headerlink" title="CSRF可以做什么"></a>CSRF可以做什么</h1><p>你这可以这么理解CSRF攻击：攻击者盗用了你的身份，以你的名义发送恶意请求。CSRF能够做的事情包括：以你名义发送邮件，发消息，盗取你的账号，甚至于购买商品，虚拟货币转账……造成的问题包括：个人隐私泄露以及财产安全。<br><a id="more"></a></p>
<h1 id="CSRF原理"><a href="#CSRF原理" class="headerlink" title="CSRF原理"></a>CSRF原理</h1><p><img src="/2019/02/07/CSRF漏洞/1.png" alt=""></p>
<p>要想完成一次CSRF攻击的话，得满足两个条件:  </p>
<ol>
<li>受害者登陆受信任的网站A，并在本地生成Cookie。</li>
<li>在不退出A网站的情况下，访问危险网站B。<h1 id="演示"><a href="#演示" class="headerlink" title="演示"></a>演示</h1>1.<br>演示的话，最简单的就是银行转账了。<br>银行网站A，它以GET请求来完成银行转账的操作，如：<br><code>http://www.mybank.com/Transfer.php?BankId=11&amp;money=1000</code><br>危险网站B，有一段代码如下:<br><code>&lt;img src=http://www.mybank.com/Transfer.php?BankId=11&amp;money=1000&gt;</code>  </li>
</ol>
<p>首先，你登陆了银行网站，然后又去访问危险网站B，结果回到银行网站A时你发现钱少了……钱少了……  </p>
<p>原因是银行网站A违反了HTTP规范，使用GET请求更新资源，在访问时你已经登陆了银行网站A，而B中的  <code>&lt;img&gt;标签</code>  以GET方式请求第三方资源（这里的第三方就是指银行网站了，原本这是一个合法的请求，但这里被不法分子利用了），所以你的浏览器会带上你的银行网站A的Cookie发出Get请求，去获取资源   <code>http://www.mybank.com /Transfer.php?BankId=11&amp;money=1000</code>，结果银行网站服务器收到请求后，认为这是一个更新资源操作（转账 操作），所以就立刻进行转账操作，所以钱没了……钱没了……</p>
<p>2.<br>后台代码使用  <strong>$_POST+$_REQUEST[]</strong>  进行传参<br>你可能说既然get不安全，那我用post。但是下面这种post还是会被攻击。<br>银行网站A的WEB表单如下:<br><img src="/2019/02/07/CSRF漏洞/2.png" alt=""></p>
<p>后台处理页面Transfer.php如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">　　&lt;?php</span><br><span class="line">　　　　session_start();</span><br><span class="line">　　　　if (isset($_REQUEST[&apos;BankId&apos;] &amp;&amp;　isset($_ REQUEST[&apos;money&apos;]))</span><br><span class="line">　　　　&#123;</span><br><span class="line">　　　　    buy_stocks($_REQUEST[&apos;BankId&apos;],　$_REQUEST[&apos;money&apos;]);</span><br><span class="line">　　　　&#125;</span><br></pre></td></tr></table></figure></p>
<p>危险网站B，仍是包含那句HTML代码：<br><code>&lt;img src=http://www.mybank.com/Transfer.php?toBankId=11&amp;money=1000&gt;</code>   </p>
<p>然后还像之前那样访问网站，会发现钱又没了……  </p>
<p>银行后台使用了  <strong>$_REQUEST</strong>  去获取请求的数据，而  <strong>$_REQUEST</strong> 既可以获取GET请求的数据，也可以获取POST请求的数据，这就造成 了在后台处理程序无法区分这到底是GET请求的数据还是POST请求的数据。<br><strong>CSRF攻击是源于WEB的隐式身份验证机制！WEB的身份验证机制虽然可以保证一个请求是来自于某个用户的浏览器，但却无法保证该请求是用户批准发送的！</strong></p>
<h1 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h1><p>burpsuite可以实现csrf的检测</p>
<h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><p>进行重要敏感操作时，加入验证码</p>
<p>二次验证，进行重要敏感操作时，要求用户进行二次验证。</p>
<h2 id="http-Referer-验证"><a href="#http-Referer-验证" class="headerlink" title="http Referer 验证"></a>http Referer 验证</h2><p>可以通过      <strong>$_SERVER[]</strong> 数组来判断请求是客户端的请求，还是恶意网站的请求。</p>
<p><strong>$_SERVER</strong> 是一个包含了诸如头信息(header)、路径(path)、以及脚本位置(script locations)等等信息的数 组。这个数组中的项目由Web服务器创建。</p>
<pre><code>$_SERVER[&apos;SERVER_NAME&apos;]//服务器主机的名称。  
$_SERVER[&apos;HTTP_REFERER&apos;]//链接到当前页面的前一页面的URL地址
</code></pre><p><strong>检测代码</strong></p>
<p><code>if(stripos($_SERVER[&#39;HTTP_REFERER&#39;],$_SERVER[&#39;SERVER_NAME&#39;]!==false)){}</code></p>
<p>stripos（a,b）函数是查找b在a中首次出现的位置，如果b不存在于a中，返回false或者等同于FALSE的非 布尔值。</p>
<p><strong>实现原理</strong> </p>
<p>所以在后台加上这段判断代码，就可以来判断这一请求是合法的请求，还是恶意网站的CSRF攻击。 如果是合法的请求，  <strong>$_SERVER[‘HTTP_REFERER’]</strong>  中的url就应该含有合法网站得主机名，所以返回值就不 会全等于FALSE，相反如果是恶意网站得CSRF攻击，因为恶意的CSRF攻击都是从hacker的网站发起的， 并不是从正常网站发起的。所以 <strong>$_SERVER[‘HTTP_REFERER’]</strong> 中的url就是hacker的网站得url，自然也就不 会含有服务器主机的名称。这样就可以达到防御CSRF的目的。  </p>
<p><strong>缺陷</strong></p>
<p>Referer的值是由浏览器提供的，所以这种方法是完全依赖于浏览器的。所以如果浏览器自身存在漏 洞，Refere值可以被hacker篡改。那么这种方法就会失效.<br>有些用户认为Referer会侵犯他们的隐私权，所以会关闭浏览器的referer功能，所以网站会因为没有 Referer值而认为用户的合法请求为CSRF攻击，从而拒绝访问</p>
<h2 id="在请求中添加-token"><a href="#在请求中添加-token" class="headerlink" title="在请求中添加 token"></a>在请求中添加 token</h2><p>现在业界对CSRF的防御，一致的做法是使用一个Token（Anti CSRF Token）  </p>
<ol>
<li><p>用户访问某个表单页面。</p>
</li>
<li><p>服务端生成一个Token，放在用户的Session中，或者浏览器的Cookie中。</p>
</li>
<li><p>在页面表单附带上Token参数。</p>
</li>
<li><p>用户提交请求后， 服务端验证表单中的Token是否与用户Session（或Cookies）中的Token一致，一致为合法请求，不是则非法请求。</p>
</li>
</ol>
<p>这个Token的值必须是随机的，不可预测的。由于Token的存在，攻击者无法再构造一个带有合法Token的请求实施CSRF攻击。另外使用Token时应注意Token的保密性，尽量把敏感操作由GET改为POST，以form或AJAX形式提交，避免Token泄露。 </p>
<p><strong>具体步骤</strong><br>在提交的form表单中多添加一行: </p>
<p><img src="/2019/02/07/CSRF漏洞/3.png" alt="">  </p>
<p><strong>缺点</strong></p>
<p>1.通常一个网站可以接受请求的地方非常多，在每一个请求都添加一个token是很麻烦的，所以通常都 是使用JavaScript在加载页面的时候遍历整个DOM树，对于所有的 <strong><a></a></strong> 和 <em><form></form></em> 都添加一个token，但是 对于页面加载之后动态产生的html代码，这种方法就没有作用，只能由程序员手动添加。 2.该方法还有一个缺点是难以保证token本身的安全。特别是在一些论坛之类支持用户自己发表内容的 网站，黑客可以在上面发布自己个人网站的地址。由于系统也会在这个地址后面加上token，黑客可以 在自己的网站上得到这个token，并马上就可以发动CSRF攻击。为了避免这一点，系统可以在添加 token的时候增加一个判断，如果这个链接是链到自己本站的，就在后面添加token，如果是通向外网<br>则不加。不过，即使这个csr耂oken不以参数的形式附加在请求之中，黑客的网站也同样可以通过 Referer来得到这个token值以发动CSRF攻击。这也是一些用户喜欢手动关闭浏览器Referer功能的原因。</p>
<p><strong>注意：</strong></p>
<p>CSRF的Token仅仅用于对抗CSRF攻击。当网站同时存在XSS漏洞时候，那这个方案也是空谈。所以XSS带来的问题，应该使用XSS的防御方案予以解决。</p>

    </div>

    

    
        <div class="post-tags">
            <i class="fa fa-tags" aria-hidden="true"></i>
            <a href="/tags/web漏洞/">#web漏洞</a>
        </div>
    

    <!-- Comments -->
    
    <div class="comments">
        
<div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>



    </div>
    

</div>
        </section>

    </div>
</div>


</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about">
                <h2>About</h2>
                <p>
                    希望每个人都能找到自己的不可替代。
                </p>
            </div>
            
    <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts">
        <h2>Recent Posts</h2>
        <ul>
            
            <li>
                <a class="footer-post" href="/2019/04/24/中间件/">中间件</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/04/19/DDCTF/">DDCTF</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/04/13/CTFd的搭建/">CTFd的搭建</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/04/09/掘安杯CTF/">掘安杯CTF</a>
            </li>
            
        </ul>
    </div>



            
<div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 footer-categories">
    <h2>Categories</h2>
    <ul>
        
        <li>
            <a class="footer-post" href="/categories/CTF环境搭建/">CTF环境搭建</a>
        </li>
        
        <li>
            <a class="footer-post" href="/categories/报错/">报错</a>
        </li>
        
        <li>
            <a class="footer-post" href="/categories/docker/">docker</a>
        </li>
        
        <li>
            <a class="footer-post" href="/categories/python/">python</a>
        </li>
        
    </ul>
</div>

        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a href="https://github.com/klugjo/hexo-theme-alpha-dust">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    
                    
                    <li class="list-inline-item">
                        <a href="https://plus.google.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-google-plus"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    <li class="list-inline-item">
                        <a href="mailto:1807801293@qq.com">
                            <span class="footer-icon-container">
                                <i class="fa fa-envelope-o"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    This is Yogurt
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JavaScript -->
<script src="/js/main.js"></script>

<!-- Disqus Comments -->

<script type="text/javascript">
    var disqus_shortname = 'klugjotest';

    (function(){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/"});</script></body>

</html>